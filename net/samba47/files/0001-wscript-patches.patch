diff --git source3/modules/wscript_build source3/modules/wscript_build
index 61b776f..18fb37a 100644
--- source3/modules/wscript_build
+++ source3/modules/wscript_build
@@ -206,6 +206,14 @@ bld.SAMBA3_MODULE('vfs_solarisacl',
                  internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_solarisacl'),
                  enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_solarisacl'))
 
+bld.SAMBA3_MODULE('vfs_winmsa',
+                 subsystem='vfs',
+                 source='vfs_winmsa.c',
+                 deps='NFS4_ACLS sunacl',
+                 init_function='',
+                 internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_winmsa'),
+                 enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_winmsa'))
+
 bld.SAMBA3_MODULE('vfs_zfsacl',
                  subsystem='vfs',
                  source='vfs_zfsacl.c',
@@ -517,9 +525,40 @@ bld.SAMBA3_MODULE('vfs_error_inject',
                  internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_error_inject'),
                  enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_error_inject'))
 
+bld.SAMBA3_LIBRARY('zfs_disk_free',
+                 source='zfs_disk_free.c',
+                 includes=[
+                       '/usr/src/cddl/contrib/opensolaris/lib/libzpool/common',
+                       '/usr/src/cddl/compat/opensolaris/include',
+                       '/usr/src/cddl/compat/opensolaris/lib/libumem',
+                       '/usr/src/sys/cddl/compat/opensolaris',
+                       '/usr/src/cddl/contrib/opensolaris/head',
+                       '/usr/src/cddl/contrib/opensolaris/lib/libuutil/common',
+                       '/usr/src/cddl/contrib/opensolaris/lib/libzfs/common',
+                       '/usr/src/cddl/contrib/opensolaris/lib/libzfs_core/common',
+                       '/usr/src/cddl/contrib/opensolaris/lib/libumem/common',
+                       '/usr/src/cddl/contrib/opensolaris/lib/libnvpair',
+                       '/usr/src/sys/cddl/contrib/opensolaris/uts/common',
+                       '/usr/src/sys/cddl/contrib/opensolaris/uts/common/fs/zfs',
+                       '/usr/src/sys/cddl/contrib/opensolaris/uts/common/sys',
+                       '/usr/src/sys/cddl/contrib/opensolaris/common/zfs',
+                 ],
+                 ldflags='-lgeom -luutil -lzfs_core -lzfs',
+                 enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_zfs_space'),
+                 private_library=True)
+
 bld.SAMBA3_MODULE('vfs_delay_inject',
                  subsystem='vfs',
                  source='vfs_delay_inject.c',
                  init_function='',
                  internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_delay_inject'),
                  enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_delay_inject'))
+
+bld.SAMBA3_MODULE('vfs_zfs_space',
+                 subsystem='vfs',
+                 source='vfs_zfs_space.c',
+                 deps='zfs_disk_free',
+                 allow_undefined_symbols=True,
+                 init_function='',
+                 internal_module=bld.SAMBA3_IS_STATIC_MODULE('vfs_zfs_space'),
+                 enabled=bld.SAMBA3_IS_ENABLED_MODULE('vfs_zfs_space'))
diff --git source3/winbindd/wscript_build source3/winbindd/wscript_build
index 51264e9..5b2128d 100644
--- source3/winbindd/wscript_build
+++ source3/winbindd/wscript_build
@@ -33,6 +33,15 @@ bld.SAMBA3_MODULE('idmap_ad',
                  internal_module=bld.SAMBA3_IS_STATIC_MODULE('idmap_ad'),
                  enabled=bld.SAMBA3_IS_ENABLED_MODULE('idmap_ad'))
 
+bld.SAMBA3_MODULE('idmap_fruit',
+                 subsystem='idmap',
+                 allow_undefined_symbols=True,
+                 source='idmap_fruit.c',
+                 init_function='',
+                 deps='ads',
+                 internal_module=bld.SAMBA3_IS_STATIC_MODULE('idmap_fruit'),
+                 enabled=bld.SAMBA3_IS_ENABLED_MODULE('idmap_fruit') and bld.CONFIG_SET("HAVE_LDAP"))
+
 bld.SAMBA3_MODULE('idmap_rfc2307',
                  subsystem='idmap',
                  allow_undefined_symbols=True,
diff --git source3/wscript source3/wscript
index bc51e18..adfa10b 100644
--- source3/wscript
+++ source3/wscript
@@ -47,6 +47,7 @@ def set_options(opt):
     opt.SAMBA3_ADD_OPTION('sendfile-support')
     opt.SAMBA3_ADD_OPTION('utmp')
     opt.SAMBA3_ADD_OPTION('avahi', with_name="enable", without_name="disable")
+    opt.SAMBA3_ADD_OPTION('dnssd', with_name="enable", without_name="disable")
     opt.SAMBA3_ADD_OPTION('iconv')
     opt.SAMBA3_ADD_OPTION('acl-support')
     opt.SAMBA3_ADD_OPTION('dnsupdate')
@@ -805,7 +806,7 @@ msg.msg_accrightslen = sizeof(fd);
         conf.env['HAVE_ADS'] = '1'
         Logs.info("Building with Active Directory support.")
         # these have broken dependencies
-        forced_shared_modules.extend(TO_LIST('idmap_ad idmap_rfc2307'))
+        forced_shared_modules.extend(TO_LIST('idmap_ad idmap_fruit idmap_rfc2307'))
     elif Options.options.with_ads == False:
         Logs.info("Building without Active Directory support (--without-ads).")
     else:
@@ -872,6 +873,17 @@ msg.msg_accrightslen = sizeof(fd);
         conf.SET_TARGET_TYPE('avahi-common', 'EMPTY')
         conf.SET_TARGET_TYPE('avahi-client', 'EMPTY')
 
+    if Options.options.with_dnssd:
+        conf.env.with_dnssd = True
+        if not conf.CHECK_HEADERS('dns_sd.h'):
+            conf.env.with_dnssd = False
+        if not conf.CHECK_FUNCS_IN('DNSServiceRegister', 'dns_sd'):
+            conf.env.with_dnssd = False
+        if conf.env.with_dnssd:
+            conf.DEFINE('WITH_DNSSD_SUPPORT', 1)
+    else:
+        conf.SET_TARGET_TYPE('dns_sd', 'EMPTY')
+
     if Options.options.with_iconv:
         conf.env.with_iconv = True
         if not conf.CHECK_FUNCS_IN('iconv_open', 'iconv', headers='iconv.h'):
@@ -1726,6 +1738,7 @@ main() {
 
     if conf.CONFIG_SET('HAVE_FREEBSD_SUNACL_H'):
         default_shared_modules.extend(TO_LIST('vfs_zfsacl'))
+        default_shared_modules.extend(TO_LIST('vfs_winmsa'))
 
     if conf.CONFIG_SET('HAVE_DIRFD_DECL'):
         default_shared_modules.extend(TO_LIST('vfs_syncops vfs_dirsort'))
@@ -1745,6 +1758,9 @@ main() {
     if conf.CONFIG_SET('HAVE_LDAP'):
         default_static_modules.extend(TO_LIST('pdb_ldapsam idmap_ldap'))
 
+    if Options.options.with_libzfs:
+        default_static_modules.extend(TO_LIST('vfs_zfs_space'))
+
     if conf.CONFIG_SET('DARWINOS'):
         default_static_modules.extend(TO_LIST('charset_macosxfs'))
 
diff --git source3/wscript_build source3/wscript_build
index cc511c3..154cac8 100644
--- source3/wscript_build
+++ source3/wscript_build
@@ -240,11 +240,9 @@ bld.SAMBA3_SUBSYSTEM('SMBREGISTRY',
                         talloc
                         replace
                         util_reg
-                        samba-util
-                        samba-security
                         errors3
                         dbwrap
-                        samba3-util
+                        samba3util
                         ''')
 
 # Do not link against this use 'smbconf'
@@ -510,7 +508,7 @@ bld.SAMBA3_LIBRARY('secrets3',
 
 bld.SAMBA3_LIBRARY('smbldap',
                     source='lib/smbldap.c',
-                    deps='ldap lber samba-util smbconf',
+                    deps='ldap lber samba-util smbconf samba-debug smbconf',
                     enabled=bld.CONFIG_SET("HAVE_LDAP"),
                     private_library=False,
                     abi_directory='lib/ABI',
@@ -734,6 +732,7 @@ bld.SAMBA3_LIBRARY('smbd_base',
                         smbd_conn
                         param_service
                         AVAHI
+                        dns_sd
                         PRINTBASE
                         PROFILE
                         LOCKING
@@ -1122,6 +1121,7 @@ bld.SAMBA3_BINARY('client/smbclient',
                       msrpc3
                       RPC_NDR_SRVSVC
                       cli_smb_common
+                      dns_sd
                       archive
                       ''')
 
diff --git wscript wscript
index c9a4de4..b10fdc7 100644
--- wscript
+++ wscript
@@ -66,6 +66,14 @@ def set_options(opt):
                    dest='with_system_mitkdc',
                    default=None)
 
+    opt.add_option('--with-libzfs',
+                   help='enable libZFS support',
+                   action='store_true', dest='with_libzfs', default=False)
+
+    opt.add_option('--without-libzfs',
+                   help='disable libZFS support',
+                   action='store_false', dest='with_libzfs', default=True)
+
     opt.add_option('--without-ad-dc',
                    help='disable AD DC functionality (enables only Samba FS (File Server, Winbind, NMBD) and client utilities.',
                    action='store_true', dest='without_ad_dc', default=False)
@@ -277,6 +285,9 @@ def configure(conf):
                          msg="Checking compiler for full RELRO support"):
             conf.env['ENABLE_RELRO'] = True
 
+    if Options.options.with_libzfs != False:
+        conf.DEFINE('HAVE_LIBZFS', '1')
+
     conf.SAMBA_CONFIG_H('include/config.h')
 
 def etags(ctx):
